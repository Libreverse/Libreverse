server {
    # listen 443 ssl http2 reuseport;  # enable when terminating TLS here
    # listen 443 quic reuseport;        # HTTP/3/QUIC (requires TLS + certs)
    listen 3000 reuseport;
    server_name libreverse;
    root /home/app/webapp/public;

    # --- TLS configuration (commented until certificates are provisioned) ---
    # ssl_certificate           /etc/nginx/ssl/cert.pem;           # place certs in image/volume
    # ssl_certificate_key       /etc/nginx/ssl/key.pem;            # use ECC (prime256v1) or RSA 2048+
    # ssl_protocols             TLSv1.2 TLSv1.3;
    # ssl_prefer_server_ciphers on;
    # ssl_ciphers               'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    # ssl_ecdh_curve            X25519:prime256v1;
    # ssl_session_timeout       1d;
    # ssl_session_cache         shared:SSL:10m; # ~40k sessions
    # ssl_stapling              on;
    # ssl_stapling_verify       on;
    # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    # add_header X-Content-Type-Options nosniff always;
    # add_header X-Frame-Options DENY always;
    # add_header Referrer-Policy strict-origin-when-cross-origin always;

    # HTTP/3/QUIC support
    # add_header Alt-Svc 'h3=":443"; ma=86400';

    # Enable ModSecurity (WAF) with OWASP CRS
    modsecurity on;
    modsecurity_rules_file /etc/modsecurity/main.conf;

    passenger_enabled on;
    passenger_user app;
    # passenger_ruby defined globally; omit here to avoid duplicates
    passenger_app_env production;
    # Keep at least one app process resident to reduce cold-start latency
    passenger_min_instances 1;

    # Teach Rack::Sendfile (via Rails) how to map filesystem paths to
    # internal NGINX locations for X-Accel-Redirect acceleration.
    # This sets the X-Accel-Mapping environment variable visible to the app.
    # Multiple mappings can be provided by separating with commas.
    # Paths must end with a trailing slash.
    # Provide X-Accel-Mapping as a single value (comma-separated list)
    passenger_env_var X-Accel-Mapping /home/app/webapp/storage/=/_internal/storage/,/home/app/webapp/private/=/_internal/private/;

    # CrowdSec bouncer access check
    access_by_lua_block {
        local cs = require "crowdsec"
        if ngx.var.unix == "1" then
            ngx.log(ngx.DEBUG, "[Crowdsec] Unix socket request ignoring...")
        else
            cs.Allow(ngx.var.remote_addr)
        end
    }

    location /cable {
        passenger_app_group_name libreverse_action_cable;
        passenger_force_max_concurrent_requests_per_process 0;
    }

    # Private, accelerated sendfile locations (internal-only)
    # Files under these paths can be served by returning an
    # X-Accel-Redirect header pointing at these URIs.
    location ^~ /_internal/storage/ {
        internal;
        alias   /home/app/webapp/storage/;
    }

    location ^~ /_internal/private/ {
        internal;
        alias   /home/app/webapp/private/;
    }
}
