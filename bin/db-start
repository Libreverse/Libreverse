#!/usr/bin/env bash
# Start development databases

echo "Starting development databases..."

# Function to check if container is running
container_running() {
    podman ps --format "{{.Names}}" | grep -q "^$1$"
}

# Start TiDB if not already running
if container_running "libreverse-dev-tidb"; then
    echo "TiDB is already running"
else
    echo "Starting TiDB..."
    podman run -d -p 4000:4000 --name libreverse-dev-tidb --replace --restart=always pingcap/tidb:latest > /dev/null 2>&1
fi

# Start PostgreSQL if not already running
if container_running "libreverse-dev-postgres"; then
    echo "PostgreSQL is already running"
else
    echo "Starting PostgreSQL..."
    podman run -d -p 5432:5432 --name libreverse-dev-postgres --replace --restart=always -e POSTGRES_PASSWORD=password -e POSTGRES_DB=libreverse_cache_development postgres:15-alpine > /dev/null 2>&1
fi

# Start DragonflyDB if not already running
if container_running "libreverse-dev-dragonflydb"; then
    echo "DragonflyDB is already running"
else
    echo "Starting DragonflyDB..."
    podman run -d -p 6379:6379 --name libreverse-dev-dragonflydb --replace --restart=always --ulimit memlock=-1 docker.dragonflydb.io/dragonflydb/dragonfly --logtostderr > /dev/null 2>&1
fi

echo "Databases started. Waiting for them to be ready..."

# Wait for TiDB
echo "Waiting for TiDB..."
while ! mysql -h 127.0.0.1 -P 4000 -u root -e "SELECT 1;" >/dev/null 2>&1; do
  sleep 1
done

# Wait for PostgreSQL
echo "Waiting for PostgreSQL..."
while ! PGPASSWORD=password psql -h 127.0.0.1 -p 5432 -U postgres -d libreverse_cache_development -c "SELECT 1;" >/dev/null 2>&1; do
  sleep 1
done

echo "Databases are ready!"