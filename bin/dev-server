#!/usr/bin/env perl
use strict;
use warnings;
use FindBin;
use File::Glob 'bsd_glob';
use Term::ANSIColor;  # For colored output
use utf8;  # Enable UTF-8 for Unicode
binmode STDOUT, ':encoding(UTF-8)';  # Set output encoding to UTF-8

# Get terminal width
my $width = `tput cols` || 80;  # Default to 80 if tput fails
chomp $width;
my $box_width = 78;  # Fixed box width for better fit
my $line = "â•" x ($box_width);  # Unicode double line for polished look

# Overmind color palette (256-color indices)
my @overmind_colors = qw(224 111 150 182 186 147 216 110 174 115 175 116 218 217);
my $color_index = 0;  # To cycle through colors

# ANSI helpers for 256-color foreground and reset
my $RESET = "\e[0m";
sub _ansi_fg { my ($n) = @_; return sprintf("\e[38;5;%dm", $n); }

# Define fixed colors for different message types
my $header_color = _ansi_fg(182);
my $message_color = _ansi_fg(147);

# Function to get next color escape sequence
sub get_next_color {
    my $code = $overmind_colors[$color_index % @overmind_colors];
    $color_index++;
    return _ansi_fg($code);
}

# Clear screen for a fresh start
system('clear');

# Function to display a task with status
sub run_task {
    my ($message, $command) = @_;
    system($command);
}

# Define colors from the provided palette
my %COLORS = (
  reset  => "\033[0m",
  red    => "\033[38;5;174m",
  yellow => "\033[38;5;150m",
  cyan   => "\033[38;5;115m",
);

# Run tasks with visual feedback
run_task("Killing other overmind instances...", "pkill overmind > /dev/null 2>&1");
unlink '/tmp/.overmind.sock';
run_task("Killing anything on port 3000...", "fuser -k -TERM 3000/tcp > /dev/null 2>&1");
run_task(
    "Ensuring mkcert root CA is trusted",
    q{mkcert -install >/dev/null 2>&1 || (command -v mkcert >/dev/null && mkcert -install)}
);

$ENV{OVERMIND_SOCKET}        = '/tmp/.overmind.sock';
$ENV{OVERMIND_TMUX_CONFIG}   = '/config/dev/overmind-tmux.conf';
$ENV{OVERMIND_RESTART}       = 'all';
$ENV{OVERMIND_COLORS}        = '224,111,150,182,186,147,216,110,174,115,175,116,218,217';
$ENV{OVERMIND_CAN_DIE}       = 'startup-message';

exec 'overmind', 'start', '-f', 'config/dev-processes.yml'
