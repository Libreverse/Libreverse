- content_for :title, "Litestream Database Replication"

%div{"data-controller" => "admin-litestream"}
  %h1 Litestream Database Replication

  %h2 Configuration
  %div
    %div
      %div
        = @litestream_enabled ? "âœ“" : "âœ—"
      %div
        %h3 Status
        %p= @litestream_enabled ? "Enabled" : "Disabled"

    - if @litestream_enabled
      %div
        %div
          = @litestream_configured ? "âœ“" : "âœ—"
        %div
          %h3 Environment Variables
          %p= @litestream_configured ? "All required variables set" : "Missing environment variables"

    - unless @litestream_enabled
      %div
        %p Litestream provides automated database backups to cloud storage for data durability.
        - if @litestream_configured
          = form_with url: "/admin/litestream/enable", method: :post, local: true do |form|
            = form.submit "Enable Litestream", class: "button primary"
        - else
          %p
            To enable Litestream, first set the required environment variables:
            %strong LITESTREAM_REPLICA_BUCKET, LITESTREAM_ACCESS_KEY_ID, LITESTREAM_SECRET_ACCESS_KEY

    - if @litestream_enabled
      %div
        = form_with url: "/admin/litestream/disable", method: :post, local: true do |form|
          = form.submit "Disable Litestream", class: "button secondary",
            data: { confirm: "Are you sure you want to disable Litestream? This will stop automated database backups." }

  - if @litestream_enabled && @litestream_configured
    %h2 Replication Status
    %div
      %div
        %div
          = @litestream_running ? "â—" : "â—‹"
        %div
          %h3 Process Status
          %p= @litestream_running ? "Running" : "Not running"

      %div
        %div ðŸ“Š
        %div
          %h3 Databases
          %p #{@databases.length} configured

  - if @litestream_enabled && @missing_env_vars.any?
    %div
      %h3 Missing Environment Variables
      %p The following required environment variables are not set:
      %ul
        - @missing_env_vars.each do |var|
          %li= var
      %p Litestream replication will not start without these variables.

  %div
    %h2 Configured Databases
    - if @databases.any?
      %div
        - @databases.each do |database|
          %div
            %div
              %div
                %h3= File.basename(database["path"])
                %p= database["path"]
              %div
                %span= database["replicas"]

            %div
              %button{"data-action" => "click->admin-litestream#showGenerations", "data-database" => database["path"]}
                View Generations
              %button{"data-action" => "click->admin-litestream#showSnapshots", "data-database" => database["path"]}
                View Snapshots
              %button{"data-action" => "click->admin-litestream#verifyDatabase", "data-database" => database["path"]}
                Verify Backup
    - else
      %div
        %p No databases configured for replication.
        %p Check your Litestream configuration file.

  %div
    %h2 Actions
    %div
      = link_to "View Full Dashboard", "/admin/litestream/dashboard", target: "_blank"
      %button{"data-action" => "click->admin-litestream#refreshStatus"}
        Refresh Status

#details-modal
  %div
    %div
      #modal-title Modal Title
      %button{"data-action" => "click->admin-litestream#closeModal"} âœ•
    %div
      #modal-content Loading...
    %div
      %button{"data-action" => "click->admin-litestream#closeModal"} Close
