# Nginx configuration for Libreverse with Passenger
# This file should be customized based on your deployment environment

# Define passenger root and Ruby - these will be set in Dockerfile
# passenger_root /usr/local/bundle/gems/passenger-6.0.x;
# passenger_ruby /usr/local/bin/ruby;

# Remove nginx gzip since Rails app uses zstd compression
# gzip handled by rack-brotli and zstd-ruby in the Rails app

# Rate limiting - replace rack-attack with nginx rate limiting
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=general:10m rate=60r/m;

# Cache for static assets
map $sent_http_content_type $expires {
    default                    off;
    text/html                  epoch;
    text/css                   max;
    application/javascript     max;
    ~image/                    max;
    ~font/                     max;
    application/font-woff      max;
    application/font-woff2     max;
}

server {
    listen 80;
    listen [::]:80;
    server_name _;
    
    # Security headers - moved from Rails to nginx for better performance
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    add_header Expect-CT "max-age=86400, enforce" always;
    add_header X-Download-Options "noopen" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Document root for Rails app
    root /rails/public;
    
    # Enable Passenger
    passenger_enabled on;
    passenger_app_env production;
    passenger_min_instances 2;
    passenger_max_instances 10;
    passenger_max_requests 1000;
    passenger_memory_limit 512;
    passenger_max_request_time 30;
    
    # Ruby/Rails specific settings
    passenger_ruby /usr/local/bin/ruby;
    passenger_app_root /rails;
    passenger_startup_file config.ru;
    
    # Prestart the application for faster first request
    passenger_pre_start http://localhost;
    
    # Static file handling
    location ~ ^/(assets|packs|vite)/ {
        expires $expires;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        try_files $uri =404;
    }
    
    # Handle favicon and robots.txt
    location = /favicon.ico {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
    
    location = /robots.txt {
        expires 1d;
        add_header Cache-Control "public";
        try_files $uri =404;
    }
    
    # Action Cable WebSocket support with Passenger optimization
    location /cable {
        passenger_app_group_name libreverse_action_cable;
        passenger_force_max_concurrent_requests_per_process 0;
        passenger_enabled on;
    }
    
    # Rate limiting for login/auth endpoints
    location ~ ^/(auth|login|sign_in) {
        limit_req zone=login burst=3 nodelay;
        try_files $uri @passenger;
    }
    
    # Rate limiting for API endpoints
    location /api/ {
        limit_req zone=api burst=10 nodelay;
        try_files $uri @passenger;
    }
    
    # Main application with general rate limiting
    location / {
        limit_req zone=general burst=20 nodelay;
        try_files $uri @passenger;
    }
    
    location @passenger {
        passenger_enabled on;
    }
    
    # Security: block access to sensitive files
    location ~ /\. {
        deny all;
    }
    
    location ~ /(config|tmp|log|storage)/ {
        deny all;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        try_files $uri @passenger;
    }
    
    # Error pages
    error_page 500 502 503 504 /500.html;
    error_page 404 /404.html;
    error_page 422 /422.html;
    
    location = /500.html {
        root /rails/public;
        internal;
    }
    
    location = /404.html {
        root /rails/public;
        internal;
    }
    
    location = /422.html {
        root /rails/public;
        internal;
    }
}

# SSL/HTTPS configuration (uncomment and customize for production)
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name your-domain.com;
#     
#     # SSL certificates
#     ssl_certificate /path/to/certificate.crt;
#     ssl_certificate_key /path/to/private.key;
#     
#     # SSL configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # HSTS
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     
#     # Include the same configuration as above for the app
#     include /etc/nginx/sites-available/libreverse-shared.conf;
# }
