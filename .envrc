# DO NOT PUT ANYTHING SENSITIVE IN THIS FILE - IT GETS COMMITTED TO GIT

export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
source /opt/homebrew/opt/chruby/share/chruby/chruby.sh
chruby ruby-3.4.1
export RUBYOPT="--yjit -W0 --parser=prism --yjit-mem-size=192 --backtrace-limit=10"
export RAILS_ENV=development
export ALLOWED_HOSTS=localhost
export CORS_ORIGINS=localhost
export EEA_MODE=true
export FORCE_SSL=false
export RAILS_LOG_LEVEL=debug
export TRACE_BOOT=1
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
export CONTAINERS_MACHINE_PROVIDER=applehv
export BUNDLE_AUTO_INSTALL=1
export BUNDLE_CLEAN=0
export BUNDLE_DISABLE_SHARED_GEMS=1
export BUNDLE_DISABLE_VERSION_CHECK=1
export BUNDLE_IGNORE_FUNDING_REQUESTS=1
export BUNDLE_IGNORE_MESSAGES=1
export BUNDLE_LOCKFILE_CHECKSUMS=1
export BUNDLE_REDIRECT=2
export BUNDLE_RETRY=0
export BUNDLE_SILENCE_DEPRECATIONS=1
export BUNDLE_SILENCE_ROOT_WARNING=1
export ANYCABLE_RPC_HOST=127.0.0.1:50051
export ANYCABLE_RPC_CONCURRENCY=8
export ANYCABLE_RPC_REQUEST_TIMEOUT=5000
export ANYCABLE_REDIS_URL=redis://localhost:6379/1
export ANYCABLE_PORT=3003
export ANYCABLE_PATH=/cable
export ANYCABLE_HTTP_BROADCAST_PORT=8091
export ANYCABLE_RPC_POOL_SIZE=8
export CFLAGS="-O3 -march=native -mtune=native -pipe -flto -fomit-frame-pointer -DNDEBUG -fstrict-aliasing"
export CPPFLAGS="-DNDEBUG" 
export LDFLAGS="-flto -Wl,-O1"
export CXXFLAGS="$CFLAGS"
export VITE_RUBY_PACKAGE_MANAGER="bun"

alias_dir="$PWD/.direnv/bin"
mkdir -p "$alias_dir"

cat > "$alias_dir/pnpm" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

WRAPPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Strip the wrapper dir from PATH so we always resolve the real pnpm binary.
CLEAN_PATH=""
IFS=':' read -r -a _path_parts <<< "${PATH:-}"
for _p in "${_path_parts[@]}"; do
  [[ -z "${_p}" ]] && continue
  [[ "${_p}" == "${WRAPPER_DIR}" ]] && continue
  CLEAN_PATH="${CLEAN_PATH:+${CLEAN_PATH}:}${_p}"
done

resolve_primary_command() {
  for arg in "$@"; do
    [[ "${arg}" == "--" ]] && break
    [[ "${arg}" == -* ]] && continue
    printf '%s' "${arg}"
    return 0
  done
  return 1
}

PRIMARY_CMD="$(resolve_primary_command "$@" || true)"
[[ -z "${PRIMARY_CMD}" ]] && PRIMARY_CMD="install"

case "${PRIMARY_CMD}" in
  install|i|add|update|up|import|fetch|link|unlink|remove|rm|dedupe)
    if ! command -v sfw >/dev/null 2>&1; then
      echo "âŒ sfw (Socket Firewall) is required for pnpm ${PRIMARY_CMD} commands in this project." >&2
      echo "   Install it globally (bypassing project-local npm wrapper):" >&2
      echo "     /Users/george/.nvm/versions/node/v25.2.1/bin/npm i -g sfw" >&2
      exit 127
    fi
    exec env PATH="${CLEAN_PATH}" sfw pnpm "$@"
    ;;
  *)
    exec env PATH="${CLEAN_PATH}" pnpm "$@"
    ;;
esac
EOF

chmod +x "$alias_dir/pnpm"

export PATH="$alias_dir:$PATH"