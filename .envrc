# DO NOT PUT ANYTHING SENSITIVE IN THIS FILE - IT GETS COMMITTED TO GIT

source /opt/homebrew/opt/chruby/share/chruby/chruby.sh
source /opt/homebrew/opt/chruby/share/chruby/auto.sh
chruby truffleruby-25.0.0
chruby truffleruby-25.0.0
export RAILS_ENV=development
export ALLOWED_HOSTS=localhost
export CORS_ORIGINS=localhost
export EEA_MODE=true
export FORCE_SSL=false
export RAILS_LOG_LEVEL=debug
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
export CONTAINERS_MACHINE_PROVIDER=applehv
export PASSENGER_START_TIMEOUT=600
export DISABLE_ANONYMOUS_TELEMETRY=true
export PASSENGER_DISABLE_SECURITY_UPDATE_CHECK=true
export PASSENGER_APP_ENV=development
export PASSENGER_MIN_INSTANCES=1
export PASSENGER_MAX_POOL_SIZE=1
export PASSENGER_SPAWN_METHOD=direct
export PASSENGER_STICKY_SESSIONS=1
export PASSENGER_ADDRESS=127.0.0.1
export PASSENGER_PORT=3002
export PASSENGER_FORCE_MAX_CONCURRENT_REQUESTS_PER_PROCESS=0
export PASSENGER_ENGINE=nginx
export PASSENGER_APP_CONNECT_TIMEOUT=600
export PASSENGER_PRELOAD_BUNDLER=1
export BUNDLE_AUTO_INSTALL=1
export BUNDLE_CLEAN=0
export BUNDLE_DISABLE_SHARED_GEMS=1
export BUNDLE_DISABLE_VERSION_CHECK=1
export BUNDLE_IGNORE_FUNDING_REQUESTS=1
export BUNDLE_IGNORE_MESSAGES=1
export BUNDLE_LOCKFILE_CHECKSUMS=1
export BUNDLE_REDIRECT=2
export BUNDLE_RETRY=0
export BUNDLE_SILENCE_DEPRECATIONS=1
export BUNDLE_SILENCE_ROOT_WARNING=1
export BUNDLE_DISABLE_EXEC_LOAD=1
export TRUFFLERUBYOPT="--experimental-options --llvm.AOTCacheLoad=true --llvm.AOTCacheStore=true --llvm.C++Interop=true --llvm.loadC++Libraries=false --ruby.backtrace-limit=10 --ruby.cexts-lock=false --ruby.cexts-panama=true --ruby.did-you-mean=false --ruby.single-threaded=false --ruby.virtual-thread-fibers --heap.cacheSize=-1 --engine.IsolateMode=external --engine.CachePreinitializeContext=true --engine.CacheUpdate=newsource --engine.Mode=latency --compiler.EncodedGraphCache=true"
# Hook into the bundler command so we can filter things out
alias_dir="$PWD/.direnv/aliases"
mkdir -p "$alias_dir"

if [ -z "$_CLEAN_PATH_FOR_BUNDLE" ]; then
  export _CLEAN_PATH_FOR_BUNDLE="$PATH"
fi

cat > "$alias_dir/bundle" <<'EOF'
#!/usr/bin/env bash
CLEAN_PATH="${_CLEAN_PATH_FOR_BUNDLE:-$PATH}"

env PATH="$CLEAN_PATH" \
  /Users/$(whoami)/.gem/truffleruby/3.3.7/bin/bundle "$@" \
  2>&1 | grep --color=always -v "Cleaning all the gems on your system is dangerous!"
EOF

chmod +x "$alias_dir/bundle"
PATH_add "$alias_dir"
perl scripts/print_header.pl