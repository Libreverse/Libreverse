# DO NOT PUT ANYTHING SENSITIVE IN THIS FILE - IT GETS COMMITTED TO GIT

# NOTE:
# - DYLD_INSERT_LIBRARIES must be set *before* a process starts to affect its allocator.
# - This is intended for local development on macOS; hardened runtime / SIP can restrict
#   DYLD_* variables for some binaries.

if [[ "$(uname -s)" == "Darwin" ]]; then
  # Prefer a repo-local copy (used for packaging too):
  _mi_repo_lib="$PWD/mimalloc/libmimalloc.dylib"

  if [[ -f "${_mi_repo_lib}" ]]; then
    export DYLD_INSERT_LIBRARIES="${_mi_repo_lib}${DYLD_INSERT_LIBRARIES:+:${DYLD_INSERT_LIBRARIES}}"
  else
    # Fallback to Homebrew install if available.
    if command -v brew >/dev/null 2>&1; then
      _mi_prefix="$(brew --prefix mimalloc 2>/dev/null || true)"
      _mi_brew_lib="${_mi_prefix}/lib/libmimalloc.dylib"
      if [[ -n "${_mi_prefix}" && -f "${_mi_brew_lib}" ]]; then
        export DYLD_INSERT_LIBRARIES="${_mi_brew_lib}${DYLD_INSERT_LIBRARIES:+:${DYLD_INSERT_LIBRARIES}}"
      fi
    fi
  fi

  # Tuning variables (mimalloc v2.1+)
  export MIMALLOC_ALLOW_LARGE_OS_PAGES=1
  export MIMALLOC_ARENA_EAGER_COMMIT=1
  export MIMALLOC_PURGE_DELAY=0
  export MIMALLOC_PURGE_DECOMMITS=1
  export MIMALLOC_RESERVE_HUGE_OS_PAGES=1
  export MIMALLOC_EAGER_COMMIT_DELAY=2
  export MIMALLOC_USE_NUMA_NODES=1
fi
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
source /opt/homebrew/opt/chruby/share/chruby/chruby.sh
chruby ruby-3.4.1
export LANG=en_US.UTF-8
export TRUFFLERUBYOPT="--experimental-options \
    --cpusampler.Output=json \
    --cpusampler.OutputFile=/tmp/cpu_profile.json \
    --llvm.AOTCacheLoad=true \
    --llvm.AOTCacheStore=true \
    --llvm.C++Interop=true \
    --llvm.loadC++Libraries=false
    --ruby.backtrace-limit=10 \
    --ruby.cexts-lock=true \
    --ruby.cexts-panama=true \
    --ruby.did-you-mean=false \
    --ruby.single-threaded=false \
    --ruby.virtual-thread-fibers
    --heap.cacheSize=-1 \
    --engine.IsolateMode=external \
    --engine.CachePreinitializeContext=true \
    --engine.CacheUpdate=always \
    --engine.Mode=latency \
    --compiler.EncodedGraphCache=true \
    --engine.WarnVirtualThreadSupport=false"
         
export RUBYOPT="-W0 --disable=did_you_mean --backtrace-limit=10"
export RAILS_ENV=development
export ALLOWED_HOSTS=localhost
export CORS_ORIGINS=localhost
export EEA_MODE=true
export FORCE_SSL=false
export RAILS_LOG_LEVEL=debug
export TRACE_BOOT=1
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
export CONTAINERS_MACHINE_PROVIDER=applehv
export BUNDLE_AUTO_INSTALL=1
export BUNDLE_CLEAN=0
export BUNDLE_DISABLE_SHARED_GEMS=1
export BUNDLE_DISABLE_VERSION_CHECK=1
export BUNDLE_IGNORE_FUNDING_REQUESTS=1
export BUNDLE_IGNORE_MESSAGES=1
export BUNDLE_LOCKFILE_CHECKSUMS=1
export BUNDLE_REDIRECT=2
export BUNDLE_RETRY=0
export BUNDLE_SILENCE_DEPRECATIONS=1
export BUNDLE_SILENCE_ROOT_WARNING=1
export ANYCABLE_RPC_HOST=127.0.0.1:50051
export ANYCABLE_RPC_CONCURRENCY=8
export ANYCABLE_RPC_REQUEST_TIMEOUT=5000
export ANYCABLE_REDIS_URL=redis://localhost:6379/1
export ANYCABLE_PORT=3003
export ANYCABLE_PATH=/cable
export ANYCABLE_HTTP_BROADCAST_PORT=8091
export ANYCABLE_RPC_POOL_SIZE=8
export CFLAGS="-O3 -march=native -mtune=native -pipe -flto -fomit-frame-pointer -DNDEBUG -fstrict-aliasing"
export CPPFLAGS="-DNDEBUG" 
export LDFLAGS="-flto -Wl,-O1"
export CXXFLAGS="$CFLAGS"
export VITE_RUBY_PACKAGE_MANAGER="bun"
export NODE_NO_WARNINGS=1
export NODE_OPTIONS="NODE_OPTIONS=--experimental-vm-modules \
                    --max-old-space-size=8192"

alias_dir="$PWD/.direnv/bin"
mkdir -p "$alias_dir"

if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
  nvm use --silent 2>/dev/null || true
fi
REAL_NODE="$(command -v node)"

cat > "$alias_dir/node" <<EOF
#!/usr/bin/env bash
# Minimal-memory Node.js — forced flags, no matter who calls "node"
exec "$REAL_NODE" \
  --optimize-for-size \
  --gc_interval=100 \
  --always-osr \
  --always-sparkplug \
  --always-sparkplug \
  --always-use-string-forwarding-table \
  --concurrent-maglev-high-priority-threads \
  --concurrent-maglev-max-threads=0 \
  --concurrent-sparkplug-high-priority-threads \
  --concurrent-sparkplug-max-threads=0 \
  --concurrent-turbofan-max-threads=0 \
  --dict-property-const-tracking \
  --efficiency-mode \
  --maglev-inline-api-calls \
  --maglev-licm \
  --maglev-non-eager-inlining \
  --maglev-object-tracking \
  --maglev-truncation \
  --turbo-compress-frame-translations \
  --turbo-instruction-scheduling \
  --turbo-optimize-inlined-js-wasm-wrappers \
  --turbo-string-builder \
  --turbo-verify-allocation \
  --turbolev \
  --turbolev-non-eager-inlining \
  --turboshaft-typed-optimizations \
  --turboshaft-wasm-in-js-inlining \
  --abort-on-contradictory-flags \
  --compact-on-every-full-gc \
  --concurrent-builtin-generation \
  --concurrent-marking \
  --concurrent-marking-high-priority-threads \
  --cppgc-young-generation \
  --cppheap-concurrent-marking \
  --cppheap-incremental-marking \
  --flush-baseline-code \
  --flush-code-based-on-tab-visibility \
  --flush-code-based-on-time \
  --gc-experiment-less-compaction \
  --incremental-marking-always-user-visible \
  --memory-balancer \
  --memory-saver-mode \
  --minor-ms \
  --experimental-wasm-compilation-hints \
  --experimental-wasm-simd-opt \
  --flush-liftoff-code \
  --wasm-fast-api \
  --wasm-simd-ssse3-codegen \
  "\$@"
EOF

chmod +x "$alias_dir/node"
PATH_add "$alias_dir"

alias_dir="$PWD/.direnv/bin"

cat > "$alias_dir/pnpm" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

WRAPPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Strip the wrapper dir from PATH so we always resolve the real pnpm binary.
CLEAN_PATH=""
IFS=':' read -r -a _path_parts <<< "${PATH:-}"
for _p in "${_path_parts[@]}"; do
  [[ -z "${_p}" ]] && continue
  [[ "${_p}" == "${WRAPPER_DIR}" ]] && continue
  CLEAN_PATH="${CLEAN_PATH:+${CLEAN_PATH}:}${_p}"
done

resolve_primary_command() {
  for arg in "$@"; do
    [[ "${arg}" == "--" ]] && break
    [[ "${arg}" == -* ]] && continue
    printf '%s' "${arg}"
    return 0
  done
  return 1
}

PRIMARY_CMD="$(resolve_primary_command "$@" || true)"
[[ -z "${PRIMARY_CMD}" ]] && PRIMARY_CMD="install"

case "${PRIMARY_CMD}" in
  install|i|add|update|up|import|fetch|link|unlink|remove|rm|dedupe)
    if ! command -v sfw >/dev/null 2>&1; then
      echo "❌ sfw (Socket Firewall) is required for pnpm ${PRIMARY_CMD} commands in this project." >&2
      echo "   Install it globally (bypassing project-local npm wrapper):" >&2
      echo "     /Users/george/.nvm/versions/node/v25.2.1/bin/npm i -g sfw" >&2
      exit 127
    fi
    exec env PATH="${CLEAN_PATH}" sfw pnpm "$@"
    ;;
  *)
    exec env PATH="${CLEAN_PATH}" pnpm "$@"
    ;;
esac
EOF

chmod +x "$alias_dir/pnpm"

alias_dir="$PWD/.direnv/bin"

cat > "$alias_dir/bundle" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

WRAPPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Strip the wrapper dir from PATH so we always resolve the real bundle binary.
CLEAN_PATH=""
IFS=':' read -r -a _path_parts <<< "${PATH:-}"
for _p in "${_path_parts[@]}"; do
  [[ -z "${_p}" ]] && continue
  [[ "${_p}" == "${WRAPPER_DIR}" ]] && continue
  CLEAN_PATH="${CLEAN_PATH:+${CLEAN_PATH}:}${_p}"
done

# Use TruffleRuby by default, CRuby only when explicitly requested.
# IMPORTANT: do not call `ruby` here, because that would resolve to whatever Ruby
# is active *before* any later engine switch (e.g., inside bin/passenger-truffleruby).
TRUFFLERUBY_BIN="/Users/george/.rubies/truffleruby-25.0.0/bin/truffleruby"
CRUBY_BIN="/Users/george/.rubies/ruby-3.4.1/bin/ruby"

RUBY_BIN="${TRUFFLERUBY_BIN}"
if [[ "${USE_CRUBY:-}" == "true" ]] && [[ -x "$CRUBY_BIN" ]]; then
  RUBY_BIN="$CRUBY_BIN"
fi

if [[ ! -x "$RUBY_BIN" ]]; then
  echo "❌ Expected Ruby not found/executable: $RUBY_BIN" >&2
  echo "   (set USE_CRUBY=true to force CRuby, otherwise TruffleRuby is used)" >&2
  exit 127
fi

exec env PATH="${CLEAN_PATH}" LANG=en_US.UTF-8 "$RUBY_BIN" -S bundle "$@"
EOF

chmod +x "$alias_dir/bundle"

PATH_add "$alias_dir"