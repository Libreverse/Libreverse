# DO NOT PUT ANYTHING SENSITIVE IN THIS FILE - IT GETS COMMITTED TO GIT

export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"
source /opt/homebrew/opt/chruby/share/chruby/chruby.sh
source /opt/homebrew/opt/chruby/share/chruby/auto.sh
chruby truffleruby-25.0.0
chruby truffleruby-25.0.0
export RAILS_ENV=development
export ALLOWED_HOSTS=localhost
export CORS_ORIGINS=localhost
export EEA_MODE=true
export FORCE_SSL=false
export RAILS_LOG_LEVEL=debug
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
export CONTAINERS_MACHINE_PROVIDER=applehv
export PASSENGER_START_TIMEOUT=600
export DISABLE_ANONYMOUS_TELEMETRY=true
export PASSENGER_DISABLE_SECURITY_UPDATE_CHECK=true
export PASSENGER_APP_ENV=development
export PASSENGER_MIN_INSTANCES=1
export PASSENGER_MAX_POOL_SIZE=1
export PASSENGER_SPAWN_METHOD=direct
export PASSENGER_STICKY_SESSIONS=1
export PASSENGER_ADDRESS=127.0.0.1
export PASSENGER_PORT=3002
export PASSENGER_FORCE_MAX_CONCURRENT_REQUESTS_PER_PROCESS=0
export PASSENGER_ENGINE=nginx
export PASSENGER_APP_CONNECT_TIMEOUT=600
export PASSENGER_PRELOAD_BUNDLER=0
export PASSENGER_TURBOCACHING=true
export BUNDLE_AUTO_INSTALL=1
export BUNDLE_CLEAN=0
export BUNDLE_DISABLE_SHARED_GEMS=1
export BUNDLE_DISABLE_VERSION_CHECK=1
export BUNDLE_IGNORE_FUNDING_REQUESTS=1
export BUNDLE_IGNORE_MESSAGES=1
export BUNDLE_LOCKFILE_CHECKSUMS=1
export BUNDLE_REDIRECT=2
export BUNDLE_RETRY=0
export BUNDLE_SILENCE_DEPRECATIONS=1
export BUNDLE_SILENCE_ROOT_WARNING=1

export TRUFFLERUBYOPT="--experimental-options \
                      --llvm.AOTCacheLoad=true \
                      --llvm.AOTCacheStore=true \
                      --llvm.C++Interop=true \
                      --llvm.loadC++Libraries=false \
                      --ruby.backtrace-limit=10 \
                      --ruby.cexts-lock=false \
                      --ruby.cexts-panama=true \
                      --ruby.did-you-mean=false \
                      --ruby.single-threaded=false \
                      --ruby.virtual-thread-fibers \
                      --heap.cacheSize=-1 \
                      --engine.IsolateMode=external \
                      --engine.CachePreinitializeContext=true \
                      --engine.CacheUpdate=always \
                      --engine.Mode=latency \
                      --compiler.EncodedGraphCache=true \
                      --engine.WarnVirtualThreadSupport=false"

export NODE_NO_WARNINGS=1
export NODE_OPTIONS="NODE_OPTIONS=--experimental-vm-modules \
                    --max-old-space-size=8192"

# ---------------------
# Apply node.js options
# ---------------------

alias_dir="$PWD/.direnv/bin"
mkdir -p "$alias_dir"

# Auto-detect the real node binary from nvm based on .nvmrc
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
  nvm use --silent 2>/dev/null || true
fi
REAL_NODE="$(command -v node)"

cat > "$alias_dir/node" <<EOF
#!/usr/bin/env bash
# Minimal-memory Node.js — forced flags, no matter who calls "node"
exec "$REAL_NODE" \
  --optimize-for-size \
  --gc_interval=100 \
  --always-osr \
  --always-sparkplug \
  --always-sparkplug \
  --always-use-string-forwarding-table \
  --concurrent-maglev-high-priority-threads \
  --concurrent-maglev-max-threads=0 \
  --concurrent-sparkplug-high-priority-threads \
  --concurrent-sparkplug-max-threads=0 \
  --concurrent-turbofan-max-threads=0 \
  --dict-property-const-tracking \
  --efficiency-mode \
  --maglev-inline-api-calls \
  --maglev-licm \
  --maglev-non-eager-inlining \
  --maglev-object-tracking \
  --maglev-truncation \
  --turbo-compress-frame-translations \
  --turbo-instruction-scheduling \
  --turbo-optimize-inlined-js-wasm-wrappers \
  --turbo-string-builder \
  --turbo-verify-allocation \
  --turbolev \
  --turbolev-non-eager-inlining \
  --turboshaft-typed-optimizations \
  --turboshaft-wasm-in-js-inlining \
  --abort-on-contradictory-flags \
  --compact-on-every-full-gc \
  --concurrent-builtin-generation \
  --concurrent-marking \
  --concurrent-marking-high-priority-threads \
  --cppgc-young-generation \
  --cppheap-concurrent-marking \
  --cppheap-incremental-marking \
  --flush-baseline-code \
  --flush-code-based-on-tab-visibility \
  --flush-code-based-on-time \
  --gc-experiment-less-compaction \
  --incremental-marking-always-user-visible \
  --memory-balancer \
  --memory-saver-mode \
  --minor-ms \
  --experimental-wasm-compilation-hints \
  --experimental-wasm-simd-opt \
  --flush-liftoff-code \
  --wasm-fast-api \
  --wasm-simd-ssse3-codegen \
  "\$@"
EOF

chmod +x "$alias_dir/node"
PATH_add "$alias_dir"

# -------------------------------
# Socket Firewall (sfw) integration for pnpm
# -------------------------------

alias_dir="$PWD/.direnv/bin"

cat > "$alias_dir/pnpm" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

# Enforce Socket Firewall for all pnpm usage in this repo.
# If sfw cannot run, we fail hard (no bypass/fallback).
if ! command -v sfw >/dev/null 2>&1; then
  echo "❌ sfw (Socket Firewall) is required in this project." >&2
  echo "   Install it globally (bypassing project-local npm wrapper):" >&2
  echo "     /Users/george/.nvm/versions/node/v25.2.1/bin/npm i -g sfw" >&2
  exit 127
fi

# Avoid infinite recursion:
# sfw will exec pnpm; ensure it resolves to the real pnpm, not this wrapper.
WRAPPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CLEAN_PATH=""
IFS=':' read -r -a _sfw_path_parts <<< "${PATH:-}"
for _p in "${_sfw_path_parts[@]}"; do
  [[ -z "${_p}" ]] && continue
  [[ "${_p}" == "${WRAPPER_DIR}" ]] && continue
  CLEAN_PATH="${CLEAN_PATH:+${CLEAN_PATH}:}${_p}"
done

exec env PATH="${CLEAN_PATH}" sfw pnpm "$@"
EOF

chmod +x "$alias_dir/pnpm"

# -------------------------------
# mimalloc (macOS dev only)
# -------------------------------
# NOTE:
# - DYLD_INSERT_LIBRARIES must be set *before* a process starts to affect its allocator.
# - This is intended for local development on macOS; hardened runtime / SIP can restrict
#   DYLD_* variables for some binaries.

if [[ "$(uname -s)" == "Darwin" ]]; then
  # Prefer a repo-local copy (used for packaging too):
  _mi_repo_lib="$PWD/mimalloc/libmimalloc.dylib"

  if [[ -f "${_mi_repo_lib}" ]]; then
    export DYLD_INSERT_LIBRARIES="${_mi_repo_lib}${DYLD_INSERT_LIBRARIES:+:${DYLD_INSERT_LIBRARIES}}"
  else
    # Fallback to Homebrew install if available.
    if command -v brew >/dev/null 2>&1; then
      _mi_prefix="$(brew --prefix mimalloc 2>/dev/null || true)"
      _mi_brew_lib="${_mi_prefix}/lib/libmimalloc.dylib"
      if [[ -n "${_mi_prefix}" && -f "${_mi_brew_lib}" ]]; then
        export DYLD_INSERT_LIBRARIES="${_mi_brew_lib}${DYLD_INSERT_LIBRARIES:+:${DYLD_INSERT_LIBRARIES}}"
      fi
    fi
  fi

  # Tuning variables (mimalloc v2.1+)
  export MIMALLOC_ALLOW_LARGE_OS_PAGES=1
  export MIMALLOC_ARENA_EAGER_COMMIT=1
  export MIMALLOC_PURGE_DELAY=0
  export MIMALLOC_PURGE_DECOMMITS=1
  export MIMALLOC_RESERVE_HUGE_OS_PAGES=1
  export MIMALLOC_EAGER_COMMIT_DELAY=2
  export MIMALLOC_USE_NUMA_NODES=1

  # Dev-only debugging (leave commented unless you want allocator logs)
  # export MIMALLOC_VERBOSE=1
  # export MIMALLOC_SHOW_STATS=1
fi