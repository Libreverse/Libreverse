#!/usr/bin/env bash
set -euo pipefail

WRAPPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Strip the wrapper dir from PATH so we always resolve the real bundle binary.
CLEAN_PATH=""
IFS=':' read -r -a _path_parts <<< "${PATH:-}"
for _p in "${_path_parts[@]}"; do
  [[ -z "${_p}" ]] && continue
  [[ "${_p}" == "${WRAPPER_DIR}" ]] && continue
  CLEAN_PATH="${CLEAN_PATH:+${CLEAN_PATH}:}${_p}"
done

# Use TruffleRuby by default, CRuby only when explicitly requested.
# IMPORTANT: do not call `ruby` here, because that would resolve to whatever Ruby
# is active *before* any later engine switch (e.g., inside bin/passenger-truffleruby).
TRUFFLERUBY_BIN="/Users/george/.rubies/truffleruby-25.0.0/bin/truffleruby"
CRUBY_BIN="/Users/george/.rubies/ruby-3.4.1/bin/ruby"

RUBY_BIN="${TRUFFLERUBY_BIN}"
if [[ "${USE_CRUBY:-}" == "true" ]] && [[ -x "$CRUBY_BIN" ]]; then
  RUBY_BIN="$CRUBY_BIN"
fi

if [[ ! -x "$RUBY_BIN" ]]; then
  echo "âŒ Expected Ruby not found/executable: $RUBY_BIN" >&2
  echo "   (set USE_CRUBY=true to force CRuby, otherwise TruffleRuby is used)" >&2
  exit 127
fi

exec env PATH="${CLEAN_PATH}" LANG=en_US.UTF-8 "$RUBY_BIN" -S bundle "$@"
