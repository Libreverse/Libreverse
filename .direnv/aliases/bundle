#!/usr/bin/env bash
set -euo pipefail

# Enforce Socket Firewall for dependency-changing bundler operations.
# NOTE: Running long-lived processes via `bundle exec ...` (Sidekiq, Passenger)
# must NOT be proxied through sfw-free, otherwise they may exit with code 99 when
# opening local sockets (e.g., Redis).

SUBCOMMAND="${1:-}"
NEEDS_SFW=0
case "$SUBCOMMAND" in
  install|update|add|remove|lock|cache|package)
    NEEDS_SFW=1
    ;;
esac

if [[ "$NEEDS_SFW" -eq 1 ]] && ! command -v sfw >/dev/null 2>&1; then
  echo "âŒ sfw (Socket Firewall) is required for bundle $SUBCOMMAND in this project." >&2
  echo "   Install it globally (bypassing project-local npm wrapper):" >&2
  echo "     /Users/george/.nvm/versions/node/v25.2.1/bin/npm i -g sfw" >&2
  exit 127
fi

# Avoid infinite recursion:
# sfw will exec bundle; ensure it resolves to the real bundle, not this wrapper.
WRAPPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_PATH="${_CLEAN_PATH_FOR_BUNDLE:-$PATH}"

CLEAN_PATH=""
IFS=':' read -r -a _sfw_path_parts <<< "${BASE_PATH:-}"
for _p in "${_sfw_path_parts[@]}"; do
  [[ -z "${_p}" ]] && continue
  [[ "${_p}" == "${WRAPPER_DIR}" ]] && continue
  CLEAN_PATH="${CLEAN_PATH:+${CLEAN_PATH}:}${_p}"
done

BUNDLE_BIN="/Users/$(whoami)/.gem/truffleruby/3.3.7/bin/bundle"

if [[ "$NEEDS_SFW" -eq 1 ]]; then
  set +e
  env PATH="$CLEAN_PATH" \
    sfw "$BUNDLE_BIN" "$@" \
    2>&1 | grep --color=always -v "Cleaning all the gems on your system is dangerous!"
  bundle_status=${PIPESTATUS[0]}
  exit "$bundle_status"
fi

exec env PATH="$CLEAN_PATH" "$BUNDLE_BIN" "$@"
