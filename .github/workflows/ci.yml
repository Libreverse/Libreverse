name: CI/CD Pipeline

# Cancel in-progress runs for the same branch/PR to save CI time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Restrict workflow permissions for security
permissions:
    contents: read
    security-events: write
    actions: read

on:
    push:
        branches:
            - "main"
    pull_request:
        branches:
            - "main"

jobs:
    # Code formatting tools (runs in parallel)
    formatting:
        name: ${{ matrix.tool }}
        runs-on: ubuntu-22.04
        if: always()
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix:
                tool:
                    [
                        prettier,
                        rubocop,
                        haml-lint,
                        erb-format,
                        perltidy,
                        shfmt,
                        eslint,
                        stylelint,
                        markdownlint,
                        caddy-fmt,
                    ]

        steps:
            - name: Check out code
              uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

            - name: Setup Environment
              uses: ./.github/actions/setup-environment

            - name: Run Prettier
              if: matrix.tool == 'prettier'
              shell: bash
              run: bun prettier --write . --ignore-path .prettierignore --log-level warn

            - name: Run Rubocop
              if: matrix.tool == 'rubocop'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bin/rubocop -A

            - name: Run haml-lint
              if: matrix.tool == 'haml-lint'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bundle exec haml-lint --auto-correct

            - name: Run ERB Formatter
              if: matrix.tool == 'erb-format'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bundle exec erb-format --write

            - name: Run perltidy
              if: matrix.tool == 'perltidy'
              shell: bash
              run: |
                  set -euo pipefail
                  if ! command -v perltidy >/dev/null 2>&1; then
                    echo "Installing perltidy via apt";
                    sudo apt-get update -y >/dev/null 2>&1 || true
                    sudo apt-get install -y perltidy >/dev/null 2>&1 || { echo "perltidy apt install failed"; exit 0; }
                  fi
                  find . -type f \( -name '*.pl' -o -name '*.pm' -o -name '*.t' -o -name '*.psgi' \) \
                    -not -path './vendor/*' -not -path './node_modules/*' -not -path './.git/*' -print0 \
                    | xargs -0 -r perltidy -pro=.perltidyrc -b || true
                  # cleanup backups
                  find . -type f \( -name '*.pl.bak' -o -name '*.pm.bak' -o -name '*.t.bak' -o -name '*.psgi.bak' \) -delete 2>/dev/null || true

            - name: Run shfmt
              if: matrix.tool == 'shfmt'
              shell: bash
              run: |
                  set -euo pipefail
                  if ! command -v shfmt >/dev/null 2>&1; then
                    echo "Installing shfmt";
                    sudo bash -lc "curl -sSL https://github.com/mvdan/sh/releases/latest/download/shfmt_v3.7.0_linux_amd64 -o /usr/local/bin/shfmt && chmod +x /usr/local/bin/shfmt" || true
                  fi
                  find . -type f -name '*.sh' \
                    -not -path './vendor/*' -not -path './node_modules/*' -not -path './.git/*' -print0 \
                    | xargs -0 -r shfmt -w || true

            - name: Run ESLint
              if: matrix.tool == 'eslint'
              shell: bash
              run: bun eslint . --fix

            - name: Run Stylelint
              if: matrix.tool == 'stylelint'
              shell: bash
              run: bun stylelint '**/*.scss' --fix



            - name: Run markdownlint
              if: matrix.tool == 'markdownlint'
              shell: bash
              run: bun markdownlint-cli2 '**/*.md' '!**/node_modules/**' '!**/vendor/**' '!**/tmp/**' '!**/log/**' '!**/coverage/**' '!**/storage/**' '!**/licenses/**' --fix --config .markdownlint-cli2.jsonc

            - name: Run Caddy Fmt
              if: matrix.tool == 'caddy-fmt'
              shell: bash
              run: |
                  set -euo pipefail
                  if ! command -v caddy >/dev/null 2>&1; then
                    echo "Installing caddy";
                    sudo apt-get update -y >/dev/null 2>&1 || true
                    sudo apt-get install -y debian-keyring debian-archive-keyring apt-transport-https curl >/dev/null 2>&1 || true
                    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg >/dev/null 2>&1 || true
                    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list >/dev/null 2>&1 || true
                    sudo apt-get update -y >/dev/null 2>&1 || true
                    sudo apt-get install -y caddy >/dev/null 2>&1 || { echo "caddy apt install failed"; exit 0; }
                  fi
                  caddy fmt --overwrite Caddyfile

    # Validation tools (runs in parallel)
    validation:
        name: ${{ matrix.tool }}
        runs-on: ubuntu-22.04
        if: always()
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix:
                tool: [i18n-validation, erb-lint, hadolint, active-record-doctor, ruumba, zeitwerk-check]

        steps:
            - name: Check out code
              uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

            - name: Setup Environment
              uses: ./.github/actions/setup-environment

            - name: Run i18n validation
              if: matrix.tool == 'i18n-validation'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' ruby scripts/i18n_validate.rb

            - name: Run ERB Lint
              if: matrix.tool == 'erb-lint'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bundle exec erblint --config .erb-lint.yml app/views

            - name: Run Hadolint
              if: matrix.tool == 'hadolint'
              uses: hadolint/hadolint-action@v3.1.0
              with:
                  recursive: true

            - name: Run Active Record Doctor
              if: matrix.tool == 'active-record-doctor'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bundle exec active_record_doctor

            - name: Run Ruumba
              if: matrix.tool == 'ruumba'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bundle exec ruumba

            - name: Run Zeitwerk Check
              if: matrix.tool == 'zeitwerk-check'
              shell: bash
              run: RUBYOPT='--yjit --yjit-exec-mem-size=2 --yjit-mem-size=3 --yjit-call-threshold=1 --yjit-cold-threshold=1000000 ' bundle exec rails zeitwerk:check

    # Security analysis (runs in parallel)
    security-analysis:
        name: ${{ matrix.tool }}
        runs-on: ubuntu-22.04
        if: always()
        permissions:
            contents: read
            security-events: write
        strategy:
            fail-fast: false
            matrix:
                tool: [brakeman, bundle-audit, npm-audit]

        steps:
            - name: Check out code
              uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

            - name: Setup Environment
              uses: ./.github/actions/setup-environment
              env:
                  MATRIX_JOB: security-${{ matrix.tool }}

            - name: Run Security Analysis
              uses: ./.github/actions/security-analysis
              with:
                  tool: ${{ matrix.tool }}

    # Code quality analysis (runs in parallel)
    code-quality:
        name: ${{ matrix.tool }}
        runs-on: ubuntu-22.04
        if: always()
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix:
                tool: [fasterer, coffeelint, typos, electronegativity]

        steps:
            - name: Check out code
              uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

            - name: Setup Environment
              uses: ./.github/actions/setup-environment
              env:
                  MATRIX_JOB: quality-${{ matrix.tool }}

            - name: Run Code Quality Analysis
              uses: ./.github/actions/code-quality
              with:
                  tool: ${{ matrix.tool }}

    # Testing (runs in parallel)
    testing:
        name: ${{ matrix.test-suite }}
        runs-on: ubuntu-22.04
        permissions:
            contents: read
        env:
            TIDB_HOST: ${{ secrets.TIDB_HOST }}
            TIDB_USERNAME: ${{ secrets.TIDB_USERNAME }}
            TIDB_PASSWORD: ${{ secrets.TIDB_PASSWORD }}
        strategy:
            fail-fast: false
            matrix:
                test-suite: [jest, rails-test]

        steps:
            - name: Check out code
              uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

            - name: Setup Environment
              uses: ./.github/actions/setup-environment
              env:
                  MATRIX_JOB: test-${{ matrix.test-suite }}

            - name: Run Tests
              uses: ./.github/actions/run-tests
              with:
                  test-suite: ${{ matrix.test-suite }}

    # Build and deployment (only runs on main branch and after quality checks pass)
    build-push:
        name: Build & Deploy
        runs-on: ubuntu-22.04
        permissions:
            contents: read
            packages: write
        needs: [formatting, validation, security-analysis, code-quality] # removed testing
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && github.actor != 'github-actions[bot]' && github.event.head_commit != null && !contains(github.event.head_commit.message, 'chore(')

        steps:
            - name: Check out code
              uses: actions/checkout@v4
            - name: Bypass Cloudflare for Github Action
              uses: ./.github/actions/bypass-cloudflare
              with:
                  cf_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
                  cf_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Log in to Quay
              uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
              with:
                  registry: quay.io
                  username: ${{ secrets.QUAY_USERNAME }}
                  password: ${{ secrets.QUAY_PASSWORD }}

            - name: Build Docker image
              run: |
                  docker build -t quay.io/georgebaskervil/libreverse:alpha .

            - name: Push to Quay.io
              run: |
                  docker push quay.io/georgebaskervil/libreverse:alpha

            - name: Trigger Coolify Redeploy
              run: |
                  curl -X GET "https://c.geor.me/api/v1/deploy?uuid=p4wg4ssgokg08s0wkk4cw0sk&force=false" \
                  -H "Content-Type: application/json" \
                  -H "authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}"
