name: "CodeQL Security Analysis"
description: "Run CodeQL security analysis for Ruby and JavaScript/TypeScript"

inputs:
    language:
        description: "Language to analyze (ruby, javascript-typescript)"
        required: true
    upload-results:
        description: "Whether to upload results to GitHub Security tab"
        required: false
        default: "true"

runs:
    using: "composite"
    steps:
        - name: Initialize CodeQL
          uses: github/codeql-action/init@v3
          with:
              languages: ${{ inputs.language }}
              build-mode: none
              config-file: ./.github/codeql/codeql-config.yml
              queries: +security-and-quality

        - name: Perform CodeQL Analysis
          uses: github/codeql-action/analyze@v3
          with:
              category: "/language:${{ inputs.language }}"
              upload: ${{ inputs.upload-results }}
              output: sarif-results

        - name: Fail if CodeQL found issues
          shell: bash
          run: |
              sarif_file=$(find sarif-results -name "*.sarif" | head -1)
              if [ -n "$sarif_file" ] && jq -e '.runs[0].results | length > 0' "$sarif_file" > /dev/null 2>&1; then
                echo "CodeQL found security issues"
                exit 1
              fi
